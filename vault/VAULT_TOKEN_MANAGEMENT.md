# Vault Token Management

## Understanding Vault Tokens

### Root Token Generation

The **root token is always generated by Vault** during `vault operator init`. You **cannot** set a custom root token during initialization in production mode.

However, you have several options depending on your needs:

---

## Option 1: Generated Token (Current Setup) ✅ RECOMMENDED

**How it works:**
```bash
vault operator init -key-shares=1 -key-threshold=1 > /vault/data/init-keys.txt
# Generates random token like: hvs.XXXXXXXXXXXXXXXXXXXX
```

**Pros:**
- ✅ Secure - unpredictable, cryptographically random
- ✅ Production-ready
- ✅ Follows Vault best practices

**Cons:**
- ❌ Different token each time you reset Vault
- ❌ Need to update .env files after reset

**When to use:** Production, staging, or any environment requiring security

---

## Option 2: Create Predictable Token After Init (Development)

You can't set the root token during init, but you can **create a new token with root privileges** after initialization:

### Add to `vault-init.sh`:

```bash
# After Vault is initialized and unsealed...
if [ -n "$VAULT_CUSTOM_ROOT_TOKEN" ]; then
  echo "Creating custom development token..."
  
  # Create a new token with root policy
  vault token create \
    -id="$VAULT_CUSTOM_ROOT_TOKEN" \
    -policy=root \
    -no-default-policy=true \
    -orphan \
    -renewable=false \
    -period=0 \
    > /dev/null 2>&1 || echo "Token already exists"
  
  echo "✓ Custom token available: $VAULT_CUSTOM_ROOT_TOKEN"
fi
```

### Then set in docker-compose.yml:

```yaml
vault:
  environment:
    VAULT_CUSTOM_ROOT_TOKEN: "dev-root-token"  # Your custom token
```

**Pros:**
- ✅ Predictable token for development
- ✅ No need to update .env after reset

**Cons:**
- ❌ Less secure (predictable token)
- ❌ NOT for production

---

## Option 3: Dev Mode (Simplest for Development)

If you want the absolute simplest setup for local development, use Vault dev mode:

### Update `docker-compose.yml`:

```yaml
vault:
  image: hashicorp/vault:1.15
  command: server -dev -dev-root-token-id=dev-root-token
  environment:
    VAULT_DEV_ROOT_TOKEN_ID: dev-root-token
    VAULT_ADDR: http://0.0.0.0:8200
  ports:
    - "8200:8200"
```

**Pros:**
- ✅ Simplest setup
- ✅ Predictable token: `dev-root-token`
- ✅ No initialization needed
- ✅ Transit engine auto-enabled (optional)

**Cons:**
- ❌ Data stored in memory (lost on restart)
- ❌ NOT for production
- ❌ No persistence

---

## Recommendation by Environment

| Environment | Recommended Approach | Token Type |
|-------------|---------------------|------------|
| **Local Development** | Dev Mode (Option 3) | `dev-root-token` (custom) |
| **Shared Development** | Option 2 (Predictable) | `dev-root-token` (custom) |
| **Staging** | Option 1 (Generated) | Random (secure) |
| **Production** | Option 1 (Generated) | Random (secure) |

---

## Current Setup (What You Have Now)

You're using **Option 1** with persistent storage - this is the **production-ready approach**.

### To get the current token:

```bash
docker exec pos-vault cat /vault/data/init-keys.txt | grep 'Initial Root Token'
```

### To update all .env files:

```bash
TOKEN=$(docker exec pos-vault cat /vault/data/init-keys.txt | grep 'Initial Root Token' | awk '{print $NF}')
find . -name ".env" -type f -exec sed -i "s/VAULT_TOKEN=.*/VAULT_TOKEN=$TOKEN/g" {} \;
```

---

## Implementing Option 2 (Predictable Token for Development)

If you want a predictable token for easier development while keeping persistence, modify your `vault-init.sh`:

### Add after "Vault Configuration Complete":

```bash
# Create predictable development token (optional)
if [ "$VAULT_ENV" = "development" ] && [ -n "$VAULT_DEV_TOKEN" ]; then
  echo ""
  echo "Creating development token..."
  
  # Check if token already exists
  if vault token lookup "$VAULT_DEV_TOKEN" >/dev/null 2>&1; then
    echo "✓ Development token already exists: $VAULT_DEV_TOKEN"
  else
    vault token create \
      -id="$VAULT_DEV_TOKEN" \
      -policy=root \
      -no-default-policy=true \
      -orphan \
      -renewable=false \
      -period=0 \
      >/dev/null
    echo "✓ Created development token: $VAULT_DEV_TOKEN"
  fi
fi
```

### Update `docker-compose.yml`:

```yaml
vault:
  environment:
    VAULT_ENV: development
    VAULT_DEV_TOKEN: dev-root-token
```

### Update service .env files:

```bash
VAULT_TOKEN=dev-root-token
```

Now you'll have:
- ✅ Persistent storage (data survives restart)
- ✅ Predictable token (`dev-root-token`)
- ✅ No need to update .env after reset

---

## Best Practice

For **local development**, I recommend a **hybrid approach**:

1. **Use persistent Vault** (what you have now)
2. **Add predictable token creation** (Option 2 implementation above)
3. **Set VAULT_ENV=development** in docker-compose
4. **Use `dev-root-token`** in all .env files

This gives you:
- Data persistence (encrypted data survives restart)
- Development convenience (predictable token)
- Easy migration to production (just remove VAULT_ENV=development)

Would you like me to implement this hybrid approach for you?
