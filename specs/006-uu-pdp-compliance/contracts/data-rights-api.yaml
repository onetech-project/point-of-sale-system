openapi: 3.0.3
info:
  title: Data Rights API
  description: |
    API for tenant and guest data rights management according to UU PDP No.27 Tahun 2022 requirements.

    Supports:
    - Tenant data access (view all tenant data)
    - Tenant data update (business profile, team members)
    - Tenant data deletion (soft delete with grace period, hard delete)
    - Guest data access (view order and personal data via order reference)
    - Guest data deletion (anonymize PII while retaining order record)
  version: 1.0.0
  contact:
    name: POS System API Support
    email: api@possystem.example.com

servers:
  - url: https://api.possystem.example.com/v1
    description: Production API
  - url: http://localhost:8080/v1
    description: Local development

tags:
  - name: Tenant Data Rights
    description: Tenant data access and management
  - name: Guest Data Rights
    description: Guest data access and deletion

paths:
  /tenant/data:
    get:
      tags:
        - Tenant Data Rights
      summary: View all tenant data
      description: |
        Retrieve all data associated with authenticated tenant's account.

        **Includes**:
        - Business profile (name, contact, settings)
        - Team members (users with roles)
        - Tenant configurations (payment settings, notification preferences)
        - Order history summary (aggregated, not individual orders)

        **Excludes** (use specific endpoints):
        - Individual order details (use /orders/:id)
        - Product catalog (use /products)
        - Audit trail (use /audit/tenant)
      operationId: getTenantData
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Tenant data retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/TenantData"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          description: Insufficient permissions (only tenant owners can access)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /tenant/data/export:
    post:
      tags:
        - Tenant Data Rights
      summary: Export all tenant data
      description: |
        Request full data export for tenant (machine-readable format).

        **Format**: JSON (default) or CSV (for tabular data like users, orders)
        **Delivery**: Email link to download (large exports) or immediate response (small exports <1MB)
        **Retention**: Export file available for 7 days
      operationId: exportTenantData
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [json, csv]
                  default: json
                  description: Export format
                include_deleted:
                  type: boolean
                  default: false
                  description: Include soft-deleted records
      responses:
        "202":
          description: Export request accepted (processing asynchronously)
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      export_id:
                        type: string
                        format: uuid
                        example: "e7dd291f-3dha-5aaa-bb34-cef6g8765224"
                      status:
                        type: string
                        enum: [pending, processing, completed, failed]
                        example: "pending"
                      estimated_completion:
                        type: string
                        format: date-time
                        example: "2026-01-02T10:45:00Z"
                      notification_method:
                        type: string
                        example: "Email will be sent to user@example.com when export is ready"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "429":
          description: Rate limit exceeded (max 1 export per hour)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /tenant/users/{user_id}:
    delete:
      tags:
        - Tenant Data Rights
      summary: Delete team member
      description: |
        Delete team member from tenant account.

        **Soft Delete** (default):
        - User status set to 'deleted'
        - Data retained for 90 days (grace period)
        - User can be restored during grace period
        - Permanent deletion after 90 days

        **Hard Delete** (with confirmation):
        - Immediate permanent deletion
        - Cannot be undone
        - Requires `force=true` parameter and confirmation
      operationId: deleteTenantUser
      security:
        - BearerAuth: []
      parameters:
        - name: user_id
          in: path
          required: true
          description: User ID to delete
          schema:
            type: string
            format: uuid
        - name: force
          in: query
          required: false
          description: Force hard delete (immediate permanent deletion)
          schema:
            type: boolean
            default: false
      responses:
        "200":
          description: User deleted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      user_id:
                        type: string
                        format: uuid
                        example: "c8ee302g-4eib-6bbb-cc45-dfg7h9876335"
                      deletion_type:
                        type: string
                        enum: [soft, hard]
                        example: "soft"
                      deleted_at:
                        type: string
                        format: date-time
                        example: "2026-01-02T10:30:00Z"
                      permanent_deletion_date:
                        type: string
                        format: date-time
                        nullable: true
                        description: When hard delete will occur (for soft deletes)
                        example: "2026-04-02T10:30:00Z"
                      message:
                        type: string
                        example: "User soft deleted. Data will be permanently deleted on 2026-04-02. User can be restored before this date."
        "400":
          description: Cannot delete last owner or user has pending obligations
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                lastOwner:
                  summary: Cannot delete last owner
                  value:
                    error:
                      code: LAST_OWNER
                      message: "Cannot delete the only tenant owner. Assign another user as owner first."
                pendingObligations:
                  summary: User has pending orders
                  value:
                    error:
                      code: PENDING_OBLIGATIONS
                      message: "User has pending orders. Complete or reassign orders before deletion."
                      details:
                        pending_order_count: 3
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "404":
          description: User not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /guest/order/{order_reference}/data:
    get:
      tags:
        - Guest Data Rights
      summary: View guest order data
      description: |
        Retrieve guest order data including all personal information.

        **Authentication**: Requires order reference + email/phone verification
        **Includes**:
        - Customer name, email, phone
        - Delivery address
        - Order items and amounts
        - Order status and timestamps
        - Consent records

        **Note**: If data has been anonymized (`is_anonymized = true`), returns limited order information with "Deleted User" for PII fields.
      operationId: getGuestOrderData
      parameters:
        - name: order_reference
          in: path
          required: true
          description: Unique order reference (e.g., "ORD-20260102-ABC123")
          schema:
            type: string
        - name: email
          in: query
          required: false
          description: Customer email (one of email or phone required)
          schema:
            type: string
            format: email
        - name: phone
          in: query
          required: false
          description: Customer phone (one of email or phone required)
          schema:
            type: string
      responses:
        "200":
          description: Guest order data retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/GuestOrderData"
        "400":
          description: Missing email or phone parameter
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Email or phone does not match order
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Order not found
        "500":
          $ref: "#/components/responses/InternalServerError"

  /guest/order/{order_reference}/delete:
    post:
      tags:
        - Guest Data Rights
      summary: Request guest data deletion
      description: |
        Anonymize guest personal data while retaining order record for merchant.

        **What gets deleted**:
        - Customer name → "Deleted User"
        - Customer email → NULL
        - Customer phone → NULL
        - Delivery address → "Address Deleted"
        - IP address → NULL
        - Geographic coordinates → NULL

        **What is retained**:
        - Order reference (for merchant records)
        - Order items and amounts
        - Order timestamps and status
        - Payment transaction records (merchant copy, no customer PII)

        **Legal basis**: UU PDP No.27 Tahun 2022 Article 3 (Right to Erasure)
        **Retention**: Order retained for 5 years per Indonesian tax law
      operationId: deleteGuestOrderData
      parameters:
        - name: order_reference
          in: path
          required: true
          description: Unique order reference
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email_or_phone
                - confirmation
              properties:
                email_or_phone:
                  type: string
                  description: Customer email or phone for verification
                  example: "customer@example.com"
                confirmation:
                  type: boolean
                  description: Must be true to confirm deletion understanding
                  example: true
      responses:
        "200":
          description: Guest data anonymized successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      order_reference:
                        type: string
                        example: "ORD-20260102-ABC123"
                      anonymized_at:
                        type: string
                        format: date-time
                        example: "2026-01-02T11:00:00Z"
                      deleted_fields:
                        type: array
                        items:
                          type: string
                        example:
                          [
                            "customer_name",
                            "customer_email",
                            "customer_phone",
                            "delivery_address",
                            "ip_address",
                          ]
                      retained_fields:
                        type: array
                        items:
                          type: string
                        example:
                          [
                            "order_reference",
                            "order_items",
                            "order_total",
                            "order_status",
                            "timestamps",
                          ]
                      message:
                        type: string
                        example: "Your personal data has been deleted. Order record retained for merchant with anonymized customer information."
        "400":
          description: Confirmation not provided or order already anonymized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                alreadyAnonymized:
                  summary: Data already deleted
                  value:
                    error:
                      code: ALREADY_ANONYMIZED
                      message: "Personal data for this order has already been deleted."
                      details:
                        anonymized_at: "2025-12-15T09:30:00Z"
        "401":
          description: Email or phone does not match order
        "404":
          description: Order not found
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token for tenant users

  schemas:
    TenantData:
      type: object
      required:
        - tenant
        - users
        - configuration
        - statistics
      properties:
        tenant:
          type: object
          properties:
            id:
              type: string
              format: uuid
            business_name:
              type: string
              example: "Warung Makan Sederhana"
            slug:
              type: string
              example: "warung-makan-sederhana"
            status:
              type: string
              enum: [active, suspended, deleted]
              example: "active"
            created_at:
              type: string
              format: date-time
        users:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
                format: uuid
              email:
                type: string
                format: email
              first_name:
                type: string
              last_name:
                type: string
              role:
                type: string
                enum: [owner, manager, cashier]
              status:
                type: string
                enum: [active, suspended, deleted]
              created_at:
                type: string
                format: date-time
        configuration:
          type: object
          properties:
            notification_preferences:
              type: object
              additionalProperties: true
            payment_gateway:
              type: string
              example: "midtrans"
            locale:
              type: string
              example: "id"
        statistics:
          type: object
          description: Aggregated statistics (not individual records)
          properties:
            total_orders:
              type: integer
              example: 1250
            total_revenue:
              type: number
              format: float
              example: 125000000.50
            user_count:
              type: integer
              example: 5

    GuestOrderData:
      type: object
      required:
        - order_reference
        - customer
        - order_items
        - is_anonymized
      properties:
        order_reference:
          type: string
          example: "ORD-20260102-ABC123"
        customer:
          type: object
          properties:
            name:
              type: string
              example: "John Doe"
              description: Shows "Deleted User" if anonymized
            email:
              type: string
              format: email
              nullable: true
              example: "john@example.com"
              description: NULL if anonymized
            phone:
              type: string
              nullable: true
              example: "+628123456789"
              description: NULL if anonymized
        delivery_address:
          type: object
          nullable: true
          properties:
            address:
              type: string
              example: "Jl. Merdeka No. 123, Jakarta"
              description: Shows "Address Deleted" if anonymized
            latitude:
              type: number
              format: float
              nullable: true
              example: -6.2088
              description: NULL if anonymized
            longitude:
              type: number
              format: float
              nullable: true
              example: 106.8456
              description: NULL if anonymized
        order_items:
          type: array
          items:
            type: object
            properties:
              product_name:
                type: string
                example: "Nasi Goreng"
              quantity:
                type: integer
                example: 2
              unit_price:
                type: number
                format: float
                example: 25000.00
              subtotal:
                type: number
                format: float
                example: 50000.00
        order_total:
          type: number
          format: float
          example: 55000.00
        order_status:
          type: string
          enum: [pending, confirmed, completed, cancelled]
          example: "completed"
        created_at:
          type: string
          format: date-time
          example: "2026-01-02T08:30:00Z"
        completed_at:
          type: string
          format: date-time
          nullable: true
          example: "2026-01-02T09:15:00Z"
        is_anonymized:
          type: boolean
          description: Whether personal data has been deleted
          example: false
        anonymized_at:
          type: string
          format: date-time
          nullable: true
          example: null
        consents:
          type: array
          description: Guest consents for this order
          items:
            type: object
            properties:
              purpose_code:
                type: string
                example: "order_processing"
              granted:
                type: boolean
                example: true
              granted_at:
                type: string
                format: date-time

    ErrorResponse:
      type: object
      required:
        - error
      properties:
        error:
          type: object
          required:
            - code
            - message
          properties:
            code:
              type: string
              description: Machine-readable error code
              example: "UNAUTHORIZED"
            message:
              type: string
              description: Human-readable error message (localized)
              example: "Invalid email or phone for order verification"
            details:
              type: object
              description: Additional error context
              additionalProperties: true

  responses:
    Unauthorized:
      description: Authentication required or invalid credentials
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: UNAUTHORIZED
              message: "Authentication required. Please provide valid JWT token."

    Forbidden:
      description: Insufficient permissions
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: FORBIDDEN
              message: "You do not have permission to perform this action. Only tenant owners can access this endpoint."

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorResponse"
          example:
            error:
              code: INTERNAL_ERROR
              message: "An unexpected error occurred. Please try again later."
              details:
                request_id: "req_xyz789abc"
