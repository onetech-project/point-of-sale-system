# Implementation Plan: Order Email Notifications

**Branch**: `004-order-email-notifications` | **Date**: 2025-12-11 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/004-order-email-notifications/spec.md`

**Note**: This plan was generated by the `/speckit.plan` command.

## Summary

Implement email notifications for paid orders: send real-time alerts to configured tenant staff members and email receipts to guest customers. Uses existing notification-service infrastructure with SMTP provider, Kafka events from order-service, and HTML email templates with PAID watermark for customer receipts. Includes admin dashboard for configuring staff notification preferences, viewing notification history, and testing email delivery.

**Key Capabilities**:
- Staff receive order notifications within 1 minute of payment
- Customers receive invoice-style receipts with PAID watermark
- Duplicate prevention via transaction ID tracking
- Automatic retry with exponential backoff (1min, 5min, 15min)
- Admin configuration and history viewing

## Technical Context

**Language/Version**: Go 1.21+  
**Primary Dependencies**: Echo v4, Kafka (Shopify/sarama), PostgreSQL driver (lib/pq), Go html/template, net/smtp  
**Storage**: PostgreSQL with Row Level Security (RLS), existing notifications table + new columns/tables  
**Testing**: Go testing package, testify for assertions, mock SMTP server, Kafka test containers  
**Target Platform**: Linux Docker containers, deployed via docker-compose  
**Project Type**: Microservices web application (backend services + Next.js frontend)  
**Performance Goals**: 
- Email delivery within 1 minute for 99% of orders
- Support 10K orders/day (0.12 emails/sec avg, 1.2 emails/sec peak)
- Notification history queries <100ms with pagination
**Constraints**: 
- Email failures must not block order processing (async, fire-and-forget)
- 90-day notification history retention
- Mobile-responsive email templates for 95%+ client compatibility
**Scale/Scope**: 
- ~10 tenants initially, scaling to 100+
- 3 new database migrations, 2 new indexes
- 7 REST API endpoints, 1 Kafka event type
- 2 email templates (staff notification + invoice with watermark)

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ✅ Principle I: Microservice Autonomy
**Status**: PASS  
**Rationale**: 
- notification-service owns email sending responsibility (existing pattern)
- order-service publishes events, doesn't directly call notification-service
- No shared databases - event-driven communication via Kafka
- Each service independently deployable

### ✅ Principle II: API-First Design
**Status**: PASS  
**Rationale**:
- Kafka event schema documented with JSON Schema validation
- 7 REST endpoints defined with OpenAPI-style contracts (request/response schemas)
- Error codes and rate limits documented
- Versioned APIs (v1)

### ✅ Principle III: Test-First Development
**Status**: PASS  
**Rationale**:
- Quickstart guide includes test-first workflow for each phase
- Unit tests for template rendering, duplicate detection, retry logic
- Contract tests for Kafka event schema
- Integration tests for end-to-end email delivery
- Acceptance tests matching BDD scenarios from spec

### ✅ Principle IV: Observability & Monitoring
**Status**: PASS  
**Rationale**:
- notifications table provides audit log of all sent emails
- Structured logging for email send attempts, failures, retries
- Prometheus metrics defined: email_sent_total, email_failed_total, delivery_duration_seconds
- Notification history API for troubleshooting

### ✅ Principle V: Security by Design
**Status**: PASS  
**Rationale**:
- Row Level Security (RLS) on notifications table (tenant isolation)
- Email address validation before sending (regex)
- Template auto-escaping (html/template prevents XSS)
- Rate limiting on admin APIs (10-100 req/min per tenant)
- PII protection: customer emails encrypted at rest, masked in logs

### ✅ Principle VI: Simplicity First (KISS + DRY + YAGNI)
**Status**: PASS  
**Rationale**:
- Reuses existing notification-service infrastructure (no new service)
- Reuses existing invoice template with CSS watermark (DRY)
- Kafka events for async communication (boring, proven technology)
- Background worker for retry (simple polling, no external scheduler)
- No premature optimization (starts with synchronous email sending, can add queue later if needed)

**Constitution Compliance**: ✅ ALL PRINCIPLES SATISFIED - No violations to justify

## Project Structure

### Documentation (this feature)

```text
specs/004-order-email-notifications/
├── plan.md              # This file (technical plan & constitution check)
├── research.md          # Phase 0: Research decisions & alternatives
├── data-model.md        # Phase 1: Entity models, relationships, queries
├── quickstart.md        # Phase 1: Step-by-step implementation guide
├── contracts/           # Phase 1: API & event contracts
│   └── api-contracts.md # REST endpoints & Kafka event schemas
├── checklists/          # Quality validation
│   └── requirements.md  # Specification completeness check
└── tasks.md             # Phase 2: NOT CREATED YET (/speckit.tasks command)
```

### Source Code (repository root)

```text
backend/
├── migrations/                          # Database schema changes
│   ├── 000023_add_order_notification_prefs.up.sql
│   ├── 000024_create_notification_configs.up.sql
│   └── 000025_add_notification_indexes.up.sql
├── notification-service/                # Email notification handler
│   ├── main.go
│   ├── api/
│   │   └── notification_history.go     # NEW: History & resend endpoints
│   ├── src/
│   │   ├── models/
│   │   │   └── notification.go         # EXTEND: Add order.paid event types
│   │   ├── services/
│   │   │   └── notification_service.go # NEW: handleOrderPaid, retry worker
│   │   ├── repository/
│   │   │   └── notification_repository.go # NEW: Duplicate check queries
│   │   └── providers/
│   │       └── providers.go            # EXISTING: SMTP email provider
│   └── templates/
│       ├── order_staff_notification.html # NEW: Staff alert email
│       └── order_invoice.html          # EXTEND: Add PAID watermark support
├── order-service/                       # Order processing & event publishing
│   ├── main.go
│   ├── src/
│   │   ├── services/
│   │   │   └── order_service.go        # EXTEND: Publish order.paid events
│   │   └── queue/
│   │       └── kafka_producer.go       # EXISTING: Kafka event publisher
│   └── tests/
│       └── integration/
│           └── order_event_test.go     # NEW: Event publishing tests
└── user-service/                        # User management & preferences
    ├── main.go
    ├── api/
    │   └── notification_preferences.go  # NEW: Preferences CRUD endpoints
    ├── src/
    │   ├── services/
    │   │   └── user_service.go         # NEW: Get/update notification prefs
    │   └── repository/
    │       └── user_repository.go      # NEW: Query users by notification flag
    └── tests/
        └── unit/
            └── notification_prefs_test.go # NEW: Preferences logic tests

frontend/
├── src/
│   ├── pages/
│   │   └── admin/
│   │       ├── settings/
│   │       │   └── notifications.tsx   # NEW: Staff notification settings UI
│   │       └── notifications/
│   │           └── history.tsx         # NEW: Notification history viewer
│   ├── services/
│   │   └── api.ts                      # EXTEND: Add notification API calls
│   └── components/
│       └── notifications/               # NEW: Notification UI components
│           ├── PreferencesTable.tsx
│           └── HistoryTable.tsx
└── tests/
    └── e2e/
        └── notification-settings.spec.ts # NEW: E2E tests for admin UI

tests/                                   # Integration & E2E tests
├── contract/
│   └── order_paid_event_test.go        # NEW: Kafka event schema validation
└── integration/
    └── email_notification_test.go      # NEW: End-to-end email flow test
```

**Structure Decision**: Option 2 (Web application) - Existing microservices backend (Go) + Next.js frontend. This feature extends 3 existing services (notification-service, order-service, user-service) and adds admin UI pages. No new services needed per YAGNI principle - notification-service already owns email responsibility.

## Complexity Tracking

**No violations** - Constitution Check passed all principles. This section is intentionally empty.
