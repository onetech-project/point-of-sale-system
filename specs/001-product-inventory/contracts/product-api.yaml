openapi: 3.0.3
info:
  title: Product & Inventory Management API
  description: |
    API for managing products, categories, and inventory in the POS system.
    All endpoints require JWT authentication and tenant context.
  version: 1.0.0
  contact:
    name: POS Team

servers:
  - url: http://localhost:8080/api/v1
    description: Local development (via API Gateway)
  - url: http://localhost:8084/api/v1
    description: Direct to Product Service

tags:
  - name: Products
    description: Product CRUD operations
  - name: Categories
    description: Category management
  - name: Inventory
    description: Stock adjustments and inventory tracking

security:
  - BearerAuth: []

paths:
  /products:
    get:
      summary: List products
      description: Retrieve paginated list of products with optional filtering
      tags: [Products]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: category_id
          in: query
          description: Filter by category
          schema:
            type: string
            format: uuid
        - name: search
          in: query
          description: Search by name or SKU
          schema:
            type: string
        - name: archived
          in: query
          description: Include archived products
          schema:
            type: boolean
            default: false
        - name: low_stock
          in: query
          description: Filter products with stock below threshold
          schema:
            type: integer
      responses:
        '200':
          description: Products retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Product'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      summary: Create product
      description: Add a new product to the catalog
      tags: [Products]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateProductRequest'
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: SKU already exists for this tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}:
    get:
      summary: Get product by ID
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update product
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProductRequest'
      responses:
        '200':
          description: Product updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: SKU already exists for this tenant
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      summary: Delete product
      description: Permanently delete product (only if no sales history)
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '204':
          description: Product deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Cannot delete product with sales history
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}/archive:
    post:
      summary: Archive product
      description: Remove product from active catalog
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product archived successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}/restore:
    post:
      summary: Restore archived product
      description: Return product to active catalog
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product restored successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Product'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}/photo:
    post:
      summary: Upload product photo
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                photo:
                  type: string
                  format: binary
                  description: Product photo (JPEG/PNG/WebP, max 5MB)
      responses:
        '200':
          description: Photo uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      photo_url:
                        type: string
                        example: /api/v1/products/123e4567-e89b-12d3-a456-426614174000/photo
        '400':
          description: Invalid file format or size
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    get:
      summary: Get product photo
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '200':
          description: Product photo
          content:
            image/jpeg:
              schema:
                type: string
                format: binary
            image/png:
              schema:
                type: string
                format: binary
            image/webp:
              schema:
                type: string
                format: binary
        '404':
          $ref: '#/components/responses/NotFound'

    delete:
      summary: Delete product photo
      tags: [Products]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      responses:
        '204':
          description: Photo deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}/stock:
    post:
      summary: Adjust stock quantity
      description: Manually adjust inventory with audit logging
      tags: [Inventory]
      parameters:
        - $ref: '#/components/parameters/ProductId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StockAdjustmentRequest'
      responses:
        '200':
          description: Stock adjusted successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: object
                    properties:
                      product:
                        $ref: '#/components/schemas/Product'
                      adjustment:
                        $ref: '#/components/schemas/StockAdjustment'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /products/{id}/adjustments:
    get:
      summary: Get stock adjustment history
      description: Retrieve audit trail of stock changes for a product
      tags: [Inventory]
      parameters:
        - $ref: '#/components/parameters/ProductId'
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Adjustment history retrieved
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/StockAdjustment'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /categories:
    get:
      summary: List categories
      tags: [Categories]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
      responses:
        '200':
          description: Categories retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Category'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

    post:
      summary: Create category
      tags: [Categories]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCategoryRequest'
      responses:
        '201':
          description: Category created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Category'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '409':
          description: Category name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

  /categories/{id}:
    get:
      summary: Get category by ID
      tags: [Categories]
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      responses:
        '200':
          description: Category retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Category'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

    put:
      summary: Update category
      tags: [Categories]
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCategoryRequest'
      responses:
        '200':
          description: Category updated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: '#/components/schemas/Category'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Category name already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          $ref: '#/components/responses/InternalError'

    delete:
      summary: Delete category
      description: Delete category (only if no products assigned)
      tags: [Categories]
      parameters:
        - $ref: '#/components/parameters/CategoryId'
      responses:
        '204':
          description: Category deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Cannot delete category with assigned products
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          $ref: '#/components/responses/InternalError'

  /inventory/adjustments:
    get:
      summary: List all stock adjustments
      description: Retrieve audit trail across all products with filtering
      tags: [Inventory]
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            minimum: 1
            default: 1
        - name: per_page
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 100
            default: 50
        - name: product_id
          in: query
          schema:
            type: string
            format: uuid
        - name: user_id
          in: query
          schema:
            type: string
            format: uuid
        - name: reason
          in: query
          schema:
            type: string
            enum: [supplier_delivery, physical_count, shrinkage, damage, return, correction, sale]
        - name: start_date
          in: query
          schema:
            type: string
            format: date-time
        - name: end_date
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Adjustments retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/StockAdjustment'
                  pagination:
                    $ref: '#/components/schemas/Pagination'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          $ref: '#/components/responses/InternalError'

  /health:
    get:
      summary: Health check
      description: Service health status
      tags: [Health]
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /ready:
    get:
      summary: Readiness check
      description: Service readiness status (database connection)
      tags: [Health]
      security: []
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ready
                  database:
                    type: string
                    example: connected
        '503':
          description: Service not ready
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: not ready
                  database:
                    type: string
                    example: disconnected

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  parameters:
    ProductId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Product UUID

    CategoryId:
      name: id
      in: path
      required: true
      schema:
        type: string
        format: uuid
      description: Category UUID

  schemas:
    Product:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        sku:
          type: string
          example: PROD-001
        name:
          type: string
          example: Coffee Beans - Medium Roast
        description:
          type: string
          nullable: true
          example: Premium Arabica coffee beans
        category_id:
          type: string
          format: uuid
          nullable: true
        category_name:
          type: string
          nullable: true
          example: Beverages
        selling_price:
          type: number
          format: decimal
          example: 15.99
        cost_price:
          type: number
          format: decimal
          example: 8.50
        tax_rate:
          type: number
          format: decimal
          example: 10.00
        stock_quantity:
          type: integer
          example: 50
        photo_url:
          type: string
          nullable: true
          example: /api/v1/products/123e4567-e89b-12d3-a456-426614174000/photo
        archived_at:
          type: string
          format: date-time
          nullable: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateProductRequest:
      type: object
      required:
        - sku
        - name
        - selling_price
        - cost_price
        - stock_quantity
      properties:
        sku:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-zA-Z0-9_-]+$'
          example: PROD-001
        name:
          type: string
          minLength: 1
          maxLength: 255
          example: Coffee Beans - Medium Roast
        description:
          type: string
          nullable: true
          example: Premium Arabica coffee beans
        category_id:
          type: string
          format: uuid
          nullable: true
        selling_price:
          type: number
          format: decimal
          minimum: 0
          example: 15.99
        cost_price:
          type: number
          format: decimal
          minimum: 0
          example: 8.50
        tax_rate:
          type: number
          format: decimal
          minimum: 0
          maximum: 100
          default: 0
          example: 10.00
        stock_quantity:
          type: integer
          example: 50

    UpdateProductRequest:
      type: object
      properties:
        sku:
          type: string
          minLength: 1
          maxLength: 50
          pattern: '^[a-zA-Z0-9_-]+$'
        name:
          type: string
          minLength: 1
          maxLength: 255
        description:
          type: string
          nullable: true
        category_id:
          type: string
          format: uuid
          nullable: true
        selling_price:
          type: number
          format: decimal
          minimum: 0
        cost_price:
          type: number
          format: decimal
          minimum: 0
        tax_rate:
          type: number
          format: decimal
          minimum: 0
          maximum: 100

    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        name:
          type: string
          example: Beverages
        display_order:
          type: integer
          example: 1
        product_count:
          type: integer
          example: 25
          description: Number of products in this category
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    CreateCategoryRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
          example: Beverages
        display_order:
          type: integer
          default: 0
          example: 1

    UpdateCategoryRequest:
      type: object
      properties:
        name:
          type: string
          minLength: 1
          maxLength: 100
        display_order:
          type: integer

    StockAdjustment:
      type: object
      properties:
        id:
          type: string
          format: uuid
        tenant_id:
          type: string
          format: uuid
        product_id:
          type: string
          format: uuid
        product_name:
          type: string
          example: Coffee Beans - Medium Roast
        user_id:
          type: string
          format: uuid
        user_name:
          type: string
          example: John Doe
        previous_quantity:
          type: integer
          example: 50
        new_quantity:
          type: integer
          example: 150
        quantity_delta:
          type: integer
          example: 100
        reason:
          type: string
          enum: [supplier_delivery, physical_count, shrinkage, damage, return, correction, sale]
          example: supplier_delivery
        notes:
          type: string
          nullable: true
          example: Received shipment from ABC Supplier
        created_at:
          type: string
          format: date-time

    StockAdjustmentRequest:
      type: object
      required:
        - new_quantity
        - reason
      properties:
        new_quantity:
          type: integer
          example: 150
        reason:
          type: string
          enum: [supplier_delivery, physical_count, shrinkage, damage, return, correction]
          example: supplier_delivery
        notes:
          type: string
          nullable: true
          example: Received shipment from ABC Supplier

    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        per_page:
          type: integer
          example: 50
        total_items:
          type: integer
          example: 250
        total_pages:
          type: integer
          example: 5

    Error:
      type: object
      properties:
        code:
          type: string
          example: VALIDATION_ERROR
        message:
          type: string
          example: Invalid input data
        details:
          type: object
          nullable: true

  responses:
    BadRequest:
      description: Invalid request data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Missing or invalid authentication token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
